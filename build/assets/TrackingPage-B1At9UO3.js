import{j as t}from"./radix-vendor-BV-zUPZ_.js";import{a as m}from"./react-vendor-BK8AH302.js";import{m as g}from"./mapbox-gl-BnguMuRq.js";import{bF as $,bG as D,aQ as P,aC as A,bq as G}from"./ui-vendor-DgaPPGCl.js";import"./map-vendor-B8JKxxRh.js";class R{trackingSessions=new Map;watchIds=new Map;listeners=new Map;geofences=new Map;startTracking(e,s,r,n,d){const c=`track-${e}-${Date.now()}`,a=this.calculateRoute(n,d),x={sessionId:c,jobId:e,driverId:s,customerId:r,startLocation:n,currentLocation:n,destinationLocation:d,route:a,status:"active",startTime:new Date,lastUpdate:new Date};return this.trackingSessions.set(c,x),this.setupGeofence(c,d,500),this.startWatchingPosition(c),console.log(`[GPS] Started tracking session: ${c}`),c}stopTracking(e){const s=this.trackingSessions.get(e);s&&(this.stopWatchingPosition(e),s.status="completed",s.lastUpdate=new Date,this.listeners.delete(e),this.geofences.delete(e),console.log(`[GPS] Stopped tracking session: ${e}`))}startWatchingPosition(e){if(!navigator.geolocation){console.error("[GPS] Geolocation not supported");return}const s=navigator.geolocation.watchPosition(r=>{const n={latitude:r.coords.latitude,longitude:r.coords.longitude,timestamp:r.timestamp,accuracy:r.coords.accuracy,speed:r.coords.speed||void 0,heading:r.coords.heading||void 0};this.updateLocation(e,n)},r=>{console.error("[GPS] Position error:",r)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:5e3});this.watchIds.set(e,s)}stopWatchingPosition(e){const s=this.watchIds.get(e);s!==void 0&&(navigator.geolocation.clearWatch(s),this.watchIds.delete(e))}updateLocation(e,s){const r=this.trackingSessions.get(e);!r||r.status!=="active"||(r.currentLocation=s,r.lastUpdate=new Date,r.route=this.calculateRoute(s,r.destinationLocation),this.checkGeofence(e,s),this.notifyListeners(e,r),console.log(`[GPS] Location updated for session: ${e}`,s))}calculateRoute(e,s){const r=this.calculateDistance(e,s),d=r/60*60,c=new Date(Date.now()+d*60*1e3),a=this.encodePolyline([e,s]);return{distance:parseFloat(r.toFixed(2)),duration:Math.ceil(d),eta:c,polyline:a}}calculateDistance(e,s){const n=this.toRad(s.latitude-e.latitude),d=this.toRad(s.longitude-e.longitude),c=Math.sin(n/2)*Math.sin(n/2)+Math.cos(this.toRad(e.latitude))*Math.cos(this.toRad(s.latitude))*Math.sin(d/2)*Math.sin(d/2);return 6371*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}toRad(e){return e*(Math.PI/180)}setupGeofence(e,s,r){this.geofences.set(e,{center:s,radius:r,triggered:!1})}checkGeofence(e,s){const r=this.geofences.get(e);if(!r||r.triggered)return;this.calculateDistance(s,r.center)*1e3<=r.radius&&(r.triggered=!0,this.onGeofenceEntered(e))}onGeofenceEntered(e){console.log(`[GPS] Geofence entered for session: ${e}`)}encodePolyline(e){return e.map(s=>`${s.latitude},${s.longitude}`).join("|")}onLocationUpdate(e,s){this.listeners.has(e)||this.listeners.set(e,[]);const r=this.listeners.get(e);return r.push(s),()=>{const n=r.indexOf(s);n>-1&&r.splice(n,1)}}notifyListeners(e,s){const r=this.listeners.get(e);r&&r.forEach(n=>n(s))}getSession(e){return this.trackingSessions.get(e)||null}getSessionByJobId(e){for(const s of this.trackingSessions.values())if(s.jobId===e&&s.status==="active")return s;return null}getAllActiveSessions(){return Array.from(this.trackingSessions.values()).filter(e=>e.status==="active")}mockUpdateLocation(e,s,r){const n={latitude:s,longitude:r,timestamp:Date.now(),accuracy:10,speed:50,heading:90};this.updateLocation(e,n)}getCurrentPosition(){return new Promise((e,s)=>{if(!navigator.geolocation){s(new Error("Geolocation not supported"));return}navigator.geolocation.getCurrentPosition(r=>{e({latitude:r.coords.latitude,longitude:r.coords.longitude,timestamp:r.timestamp,accuracy:r.coords.accuracy,speed:r.coords.speed||void 0,heading:r.coords.heading||void 0})},r=>s(r),{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})})}formatETA(e){const s=new Date,r=e.getTime()-s.getTime(),n=Math.ceil(r/1e3/60);if(n<1)return"Arriving now";if(n===1)return"1 minute";if(n<60)return`${n} minutes`;const d=Math.floor(n/60),c=n%60;return c===0?`${d} ${d===1?"hour":"hours"}`:`${d}h ${c}m`}clearAll(){this.watchIds.forEach(e=>{navigator.geolocation.clearWatch(e)}),this.trackingSessions.clear(),this.watchIds.clear(),this.listeners.clear(),this.geofences.clear(),console.log("[GPS] Cleared all tracking sessions")}}const p=new R,_={};var C={};function U({jobId:w,pickupLocation:e,deliveryLocation:s,customerName:r,driverName:n,showControls:d=!0}){const c=m.useRef(null),a=m.useRef(null),x=m.useRef(null),[u,j]=m.useState(null),[T,b]=m.useState(!0),[N,k]=m.useState(null),y=()=>{const o=typeof process<"u"&&C?.NEXT_PUBLIC_MAPBOX_TOKEN||typeof import.meta<"u"&&_?.NEXT_PUBLIC_MAPBOX_TOKEN,i=typeof window<"u"?localStorage.getItem("mapbox_token"):null;return o||i};m.useEffect(()=>((async()=>{const i=y();if(!i){k("Missing Mapbox Token"),b(!1);return}if(!a.current&&c.current){g.accessToken=i;try{b(!0),a.current=new g.Map({container:c.current,style:"mapbox://styles/mapbox/light-v11",center:[e.longitude,e.latitude],zoom:13}),a.current.addControl(new g.NavigationControl,"top-right"),a.current.on("load",()=>{if(!a.current)return;const l=document.createElement("div");l.className="w-8 h-8 bg-green-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center text-white font-bold",l.innerText="P",new g.Marker(l).setLngLat([e.longitude,e.latitude]).setPopup(new g.Popup({offset:25}).setHTML(`<b>Pickup</b><br>${r}`)).addTo(a.current);const h=document.createElement("div");h.className="w-8 h-8 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center text-white font-bold",h.innerText="D",new g.Marker(h).setLngLat([s.longitude,s.latitude]).setPopup(new g.Popup({offset:25}).setHTML("<b>Delivery</b>")).addTo(a.current);const f=new g.LngLatBounds;f.extend([e.longitude,e.latitude]),f.extend([s.longitude,s.latitude]),a.current.fitBounds(f,{padding:100}),b(!1)})}catch(l){console.error("Failed to initialize map:",l),k("Failed to load map."),b(!1)}}})(),()=>{a.current?.remove(),a.current=null}),[e,s]),m.useEffect(()=>{if(!a.current)return;let o=p.getSessionByJobId(w);if(!o){const i=p.startTracking(w,"DRV001","CUST001",e,s);o=p.getSession(i)}if(o){j(o);const i=p.onLocationUpdate(o.sessionId,l=>{j({...l}),M(l)});return M(o),()=>{i()}}},[w,e,s]);const M=o=>{if(!a.current)return;const{currentLocation:i}=o;if(x.current){x.current.setLngLat([i.longitude,i.latitude]);const h=x.current.getElement().querySelector(".driver-icon-wrapper");h&&i.heading&&(h.style.transform=`rotate(${i.heading}deg)`)}else{const l=document.createElement("div");l.innerHTML=`
        <div class="driver-icon-wrapper" style="transform: rotate(${i.heading||0}deg); transition: transform 0.3s ease;">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 fill-blue-100 drop-shadow-lg">
            <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" />
            <circle cx="7" cy="17" r="2" />
            <path d="M9 17h6" />
            <circle cx="17" cy="17" r="2" />
          </svg>
        </div>
      `,x.current=new g.Marker(l).setLngLat([i.longitude,i.latitude]).addTo(a.current)}o.status==="active"&&!a.current.getSource("route")&&L(e,s)},L=async(o,i)=>{if(!a.current)return;const l=y();if(!l)return;const f=`https://api.mapbox.com/directions/v5/mapbox/driving/${`${o.longitude},${o.latitude};${i.longitude},${i.latitude}`}?geometries=geojson&access_token=${l}`;try{const v=(await(await fetch(f)).json()).routes?.[0]?.geometry;v&&(a.current.getSource("route")?a.current.getSource("route").setData({type:"Feature",properties:{},geometry:v}):a.current.addLayer({id:"route",type:"line",source:{type:"geojson",data:{type:"Feature",properties:{},geometry:v}},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#6366F1","line-width":4,"line-opacity":.75}}))}catch(S){console.error("Route error:",S)}},E=()=>{if(!u)return;const o=u.currentLocation,i=u.destinationLocation,l=o.latitude+(i.latitude-o.latitude)*.1,h=o.longitude+(i.longitude-o.longitude)*.1;p.mockUpdateLocation(u.sessionId,l,h)};return t.jsxs("div",{className:"relative w-full h-full min-h-[500px] rounded-2xl overflow-hidden bg-slate-100",children:[t.jsx("div",{ref:c,className:"w-full h-full min-h-[500px]"}),T&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-slate-900/80 backdrop-blur-sm z-50",children:t.jsxs("div",{className:"text-center",children:[t.jsx($,{className:"w-12 h-12 text-blue-400 animate-spin mx-auto mb-4"}),t.jsx("p",{className:"text-white",children:"Loading map..."})]})}),N&&t.jsxs("div",{className:"absolute top-4 left-4 right-4 bg-yellow-500/90 backdrop-blur-sm rounded-xl p-4 flex items-center gap-3 z-50",children:[t.jsx(D,{className:"w-6 h-6 text-white flex-shrink-0"}),t.jsx("p",{className:"text-white text-sm",children:N})]}),u&&t.jsxs("div",{className:"absolute top-4 left-4 right-4 md:right-auto md:w-96 backdrop-blur-xl bg-white/10 border border-white/20 rounded-2xl p-6 shadow-2xl z-40",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[t.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center",children:t.jsx(P,{className:"w-6 h-6 text-white"})}),t.jsxs("div",{children:[t.jsx("p",{className:"text-white font-bold",children:n}),t.jsx("p",{className:"text-white/70 text-sm",children:"En route to delivery"})]})]}),t.jsx("div",{className:"backdrop-blur-lg bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-xl p-4 mb-4 border border-white/10",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(A,{className:"w-5 h-5 text-white"}),t.jsx("span",{className:"text-white/80 text-sm",children:"Estimated Arrival"})]}),t.jsx("span",{className:"text-white text-lg font-bold",children:p.formatETA(u.route.eta)})]})}),t.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[t.jsxs("div",{className:"backdrop-blur-lg bg-white/10 rounded-xl p-3 border border-white/10",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx(G,{className:"w-4 h-4 text-blue-400"}),t.jsx("span",{className:"text-white/70 text-xs",children:"Distance"})]}),t.jsxs("p",{className:"text-white text-lg font-bold",children:[u.route.distance," km"]})]}),t.jsxs("div",{className:"backdrop-blur-lg bg-white/10 rounded-xl p-3 border border-white/10",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx(P,{className:"w-4 h-4 text-green-400"}),t.jsx("span",{className:"text-white/70 text-xs",children:"Speed"})]}),t.jsx("p",{className:"text-white text-lg font-bold",children:u.currentLocation.speed?`${Math.round(u.currentLocation.speed)} km/h`:"N/A"})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[t.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full flex-shrink-0"}),t.jsxs("span",{className:"text-white/80",children:["Pickup: ",r]})]}),t.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[t.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-white/80",children:"Delivery Address"})]})]}),t.jsx("div",{className:"mt-4 pt-4 border-t border-white/10",children:t.jsxs("p",{className:"text-white/50 text-xs",children:["Last updated: ",new Date(u.lastUpdate).toLocaleTimeString()]})})]}),d&&u&&t.jsx("button",{onClick:E,className:"absolute bottom-4 right-4 px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-xl shadow-lg transition-all hover:scale-105 z-40",children:"Simulate Movement"}),t.jsx("div",{className:"absolute bottom-4 left-4 backdrop-blur-xl bg-white/10 border border-white/20 rounded-xl p-4 z-40",children:t.jsxs("div",{className:"space-y-2 text-sm",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full"}),t.jsx("span",{className:"text-white",children:"Pickup Location"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-3 h-3 bg-blue-600 rounded-full"}),t.jsx("span",{className:"text-white",children:"Driver Location"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full"}),t.jsx("span",{className:"text-white",children:"Delivery Location"})]})]})})]})}function O(){return t.jsx("div",{className:"pt-20 min-h-screen bg-slate-50",children:t.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[t.jsx("h1",{className:"text-3xl font-bold mb-6",children:"Live Tracking"}),t.jsx("div",{className:"h-[600px] rounded-2xl overflow-hidden shadow-xl border border-slate-200",children:t.jsx(U,{jobId:"demo-job",pickupLocation:{latitude:51.5074,longitude:-.1278,address:"London"},deliveryLocation:{latitude:55.9533,longitude:-3.1883,address:"Edinburgh"},customerName:"John Doe",driverName:"Mike Smith"})})]})})}export{O as default};
