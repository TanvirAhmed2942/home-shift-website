import{j as r}from"./radix-vendor-BV-zUPZ_.js";import{a as n}from"./react-vendor-BK8AH302.js";import{f as N}from"./configService-BP__dzM5.js";import{M as I}from"./mapboxConfig-B9kHtw8J.js";import{aN as w,L as S}from"./ui-vendor-DgaPPGCl.js";import{p as L,e as P}from"./index-CcmsAmAk.js";const B={};var C={};function X({onSelect:y,placeholder:s="Enter address...",defaultValue:t="",className:a=""}){const[o,i]=n.useState(t),[u,b]=n.useState([]),[d,f]=n.useState(!1),[p,h]=n.useState(!1),[m,k]=n.useState(null),[g,M]=n.useState(!0),x=n.useRef(null);n.useEffect(()=>{(async()=>{M(!0);const c=await j();k(c),M(!1)})()},[]),n.useEffect(()=>{const e=setTimeout(()=>{o&&o.length>2&&p&&m&&_(o)},500);return()=>clearTimeout(e)},[o,p,m]),n.useEffect(()=>{function e(c){x.current&&!x.current.contains(c.target)&&h(!1)}return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);const j=async()=>{const e=typeof process<"u"&&C?.NEXT_PUBLIC_MAPBOX_TOKEN||typeof import.meta<"u"&&B?.NEXT_PUBLIC_MAPBOX_TOKEN;if(e)return e;const c=typeof window<"u"?localStorage.getItem("mapbox_token"):null;if(c)return c;const l=await N();return l?.mapboxToken?(localStorage.setItem("mapbox_token",l.mapboxToken),l.mapboxToken):I},_=async e=>{if(!m){console.error("Mapbox Token missing");return}f(!0);try{const l=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(e)}.json?access_token=${m}&autocomplete=true&country=gb`)).json();l.features&&b(l.features)}catch(c){console.error("Error fetching address:",c)}finally{f(!1)}},T=e=>{i(e.place_name),h(!1),y(e.place_name,e.center[1],e.center[0])},E=e=>{i(e.target.value),h(!0)},v=!!m;return r.jsxs("div",{className:`relative ${a}`,ref:x,children:[r.jsxs("div",{className:"relative",children:[r.jsx(w,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),r.jsx("input",{type:"text",value:o,onChange:E,onFocus:()=>o.length>2&&h(!0),placeholder:g?"Loading...":v?s:"Mapbox Token Missing - Add in Environment Variables",disabled:!v||g,className:"w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"}),(d||g)&&r.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:r.jsx(S,{className:"w-4 h-4 text-blue-500 animate-spin"})})]}),p&&u.length>0&&r.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto",children:[u.map(e=>r.jsxs("button",{onClick:()=>T(e),className:"w-full text-left px-4 py-3 hover:bg-blue-50 flex items-start gap-2 border-b border-gray-50 last:border-0 transition-colors",children:[r.jsx(w,{className:"w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0"}),r.jsxs("div",{children:[r.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.place_name.split(",")[0]}),r.jsx("p",{className:"text-xs text-gray-500 truncate",children:e.place_name.split(",").slice(1).join(",")})]})]},e.id||Math.random())),r.jsx("div",{className:"px-2 py-1 bg-gray-50 text-[10px] text-right text-gray-400",children:"Powered by Mapbox"})]})]})}class O{baseUrl=`https://${L}.supabase.co/functions/v1/make-server-94f26792`;async callBackend(s,t){const a=await fetch(`${this.baseUrl}${s}`,{method:"POST",headers:{Authorization:`Bearer ${P}`,"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok){const o=await a.json();throw new Error(o.error||"Backend request failed")}return await a.json()}async calculateRoute(s,t){try{const a=await this.callBackend("/api/calculate-distance",{origin:s,destination:t});if(!a.success)throw new Error("Failed to calculate route");return{distanceMiles:a.distanceMiles,durationMinutes:a.durationMinutes,geometry:a.geometry}}catch(a){return console.error("Error calculating route via backend:",a),this.calculateHaversine(s,t)}}async calculateJourneyEstimate(s){try{const t=await this.callBackend("/api/journey/estimate",{waypoints:s});if(!t.success)throw new Error("Failed to calculate journey estimate");return{totalDistanceMiles:t.totalDistanceMiles,totalDurationMinutes:t.totalDurationMinutes,geometry:t.geometry,legs:t.legs}}catch(t){throw console.error("Error calculating journey estimate via backend:",t),t}}async allocateNearestDriver(s,t){try{const a=await this.callBackend("/api/allocate-driver",{jobLocation:s,availableDrivers:t});if(!a.success)throw new Error("Failed to allocate driver");return{driver:a.driver,etaMinutes:a.etaMinutes,distanceMiles:a.distanceMiles}}catch(a){throw console.error("Error allocating driver via backend:",a),a}}calculateHaversine(s,t){const o=(t.lat-s.lat)*Math.PI/180,i=(t.lng-s.lng)*Math.PI/180,u=Math.sin(o/2)*Math.sin(o/2)+Math.cos(s.lat*Math.PI/180)*Math.cos(t.lat*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2),d=3959*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u))),f=d>20?45:20,p=d/f*60+10;return{distanceMiles:parseFloat((d*1.2).toFixed(1)),durationMinutes:Math.round(p)}}}const q=new O;export{X as A,q as m};
